import{expect as t}from"chai";import e from"pg-promise";import o from"pg-monitor";import"exponential-backoff";import r from"dotenv";import n from"is-primitive";import i from"is-plain-object";import s from"fs";import a from"os";import{dirname as l}from"path";import{fileURLToPath as c}from"url";import{createLogger as f,format as u,transports as p}from"winston";import"bitcoin-computer-bitcore";const{deleteProperty:y}=Reflect;const m=n;const d=i;const h=t=>"object"==typeof t&&null!==t||"function"==typeof t;const g=t=>{if(!m(t))throw new TypeError("Object keys must be strings or symbols");if((t=>"__proto__"===t||"constructor"===t||"prototype"===t)(t))throw new Error(`Cannot set unsafe key: "${t}"`)};const b=(t,e)=>e&&"function"==typeof e.split?e.split(t):"symbol"==typeof t?[t]:Array.isArray(t)?t:((t,e,o)=>{const r=(t=>Array.isArray(t)?t.flat().map(String).join(","):t)(e?((t,e)=>{if("string"!=typeof t||!e)return t;let o=t+";";return void 0!==e.arrays&&(o+=`arrays=${e.arrays};`),void 0!==e.separator&&(o+=`separator=${e.separator};`),void 0!==e.split&&(o+=`split=${e.split};`),void 0!==e.merge&&(o+=`merge=${e.merge};`),void 0!==e.preservePaths&&(o+=`preservePaths=${e.preservePaths};`),o})(t,e):t);g(r);const n=S.cache.get(r)||o();return S.cache.set(r,n),n})(t,e,(()=>((t,e={})=>{const o=e.separator||".";const r="/"!==o&&e.preservePaths;if("string"==typeof t&&!1!==r&&/\//.test(t))return[t];const n=[];let i="";const s=t=>{let e;""!==t.trim()&&Number.isInteger(e=Number(t))?n.push(e):n.push(t)};for(let e=0;e<t.length;e++){const r=t[e];"\\"!==r?r!==o?i+=r:(s(i),i=""):i+=t[++e]}return i&&s(i),n})(t,e)));const v=(t,e,o,r)=>{if(g(e),void 0===o)y(t,e);else if(r&&r.merge){const n="function"===r.merge?r.merge:Object.assign;n&&d(t[e])&&d(o)?t[e]=n(t[e],o):t[e]=o}else t[e]=o;return t};const S=(t,e,o,r)=>{if(!e||!h(t))return t;const n=b(e,r);let i=t;for(let t=0;t<n.length;t++){const e=n[t];const s=n[t+1];if(g(e),void 0===s){v(i,e,o,r);break}"number"!=typeof s||Array.isArray(i[e])?(h(i[e])||(i[e]={}),i=i[e]):i=i[e]=[]}return t};S.split=b,S.cache=new Map,S.clear=()=>{S.cache=new Map};var _=S;var E=s;var w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};var O="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};var R=function(){function t(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,o,r){return o&&t(e.prototype,o),r&&t(e,r),e}}();var T=function t(e,o){var r=o.indexOf(".");if(!~r){if(null==e)return;return e[o]}var n=o.substring(0,r),i=o.substring(r+1);if(null!=e)return e=e[n],i?t(e,i):e},P=_,A=function(t,e){if("function"!=typeof e)return JSON.parse(E.readFileSync(t));E.readFile(t,"utf-8",(function(t,o){try{o=JSON.parse(o)}catch(e){t=t||e}e(t,o)}))},N=s,C=a;var k=function(){function t(e,o){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.options=o=o||{},o.stringify_width=o.stringify_width||2,o.stringify_fn=o.stringify_fn||null,o.stringify_eol=o.stringify_eol||!1,o.ignore_dots=o.ignore_dots||!1,this.path=e,this.data=this.read()}return R(t,[{key:"set",value:function(t,e,o){var r=this;return"object"===(void 0===t?"undefined":O(t))?function(t,e){var o=0,r=[];if(Array.isArray(t))for(;o<t.length&&!1!==e(t[o],o);++o);else if("object"===(void 0===t?"undefined":w(t))&&null!==t)for(r=Object.keys(t);o<r.length&&!1!==e(t[r[o]],r[o]);++o);}(t,(function(t,e){P(r.data,e,t,o)})):this.options.ignore_dots?this.data[t]=e:P(this.data,t,e,o),this.options.autosave&&this.save(),this}},{key:"get",value:function(t){return t?this.options.ignore_dots?this.data[t]:T(this.data,t):this.toObject()}},{key:"unset",value:function(t){return this.set(t,void 0)}},{key:"append",value:function(t,e){var o=this.get(t);if(o=void 0===o?[]:o,!Array.isArray(o))throw new Error("The data is not an array!");return o.push(e),this.set(t,o),this}},{key:"pop",value:function(t){var e=this.get(t);if(!Array.isArray(e))throw new Error("The data is not an array!");return e.pop(),this.set(t,e),this}},{key:"read",value:function(t){if(!t)try{return A(this.path)}catch(t){return{}}A(this.path,(function(e,o){t(null,o=e?{}:o)}))}},{key:"write",value:function(t,e){return e?N.writeFile(this.path,t,e):N.writeFileSync(this.path,t),this}},{key:"empty",value:function(t){return this.write("{}",t)}},{key:"save",value:function(t){var e=JSON.stringify(this.data,this.options.stringify_fn,this.options.stringify_width,this.options.stringify_eol);return this.write(this.options.stringify_eol?e+C.EOL:e,t),this}},{key:"toObject",value:function(){return this.data}}]),t}();r.config();const F=new k(`${l(c(import.meta.url))}/../../package.json`,{stringify_eol:!0});const{PORT:I,ZMQ_URL:M,CHAIN:$,NETWORK:j,BCN_ENV:H,BCN_URL:L,DEBUG_MODE:D,POSTGRES_USER:G,POSTGRES_PASSWORD:x,POSTGRES_DB:U,POSTGRES_HOST:W,POSTGRES_PORT:Y,RPC_PROTOCOL:B,RPC_USER:V,RPC_PASSWORD:J,RPC_HOST:z,RPC_PORT:K,SERVER_VERSION:Q,TESTING:X,DEFAULT_WALLET:Z,SYNC_HEIGHT:q,SYNC_INTERVAL_CHECK:tt,POSTGRES_MAX_PARAM_NUM:et,DB_CONNECTION_RETRY_TIME:ot,SIGNATURE_FRESHNESS_MINUTES:rt,ALLOWED_RPC_METHODS:nt,MWEB_HEIGHT:st}=process.env;const at=H||"dev";const lt=parseInt(D,10)||1;const ct=G||"bcn";const ft=x||"bcn";const ut=U||"bcn";const pt=W||"127.0.0.1";const yt=parseInt(Y,10)||"5432";Q||F.get("version"),!nt||nt.split(",").map((t=>new RegExp(t)));const mt=f({level:["error","warn","info","http","verbose","debug","silly"][lt],format:u.json(),transports:[new p.Console({format:u.combine(u.colorize(),u.timestamp({format:"MM-DD-YYYY HH:mm:ss"}),u.printf((t=>`[2m${t.timestamp}[0m ${t.level} ${t.message}`)))})],exceptionHandlers:[new p.File({filename:"logs/exceptions.log"})],rejectionHandlers:[new p.File({filename:"logs/rejections.log"})]});const dt={maxFiles:1,maxSize:1e5};lt>=0&&mt.add(new p.File({filename:"error.log",level:"error"})),lt>=1&&mt.add(new p.File({filename:"logs/warn.log",level:"warn",...dt})),lt>=2&&mt.add(new p.File({filename:"logs/info.log",level:"info",...dt})),lt>=3&&mt.add(new p.File({filename:"logs/http.log",level:"http",...dt})),lt>=4&&mt.add(new p.File({filename:"logs/verbose.log",level:"verbose",...dt})),lt>=5&&mt.add(new p.File({filename:"logs/debug.log",level:"debug",...dt}));const ht={error:(t,e)=>{if(e.cn){const{host:o,port:r,database:n,user:i,password:s}=e.cn;mt.debug(`Waiting for db to start { message:${t.message} host:${o}, port:${r}, database:${n}, user:${i}, password: ${s}`)}},noWarnings:!0};"dev"===at&&lt>0&&(o.isAttached()?o.detach():(o.attach(ht),o.setTheme("matrix")));const gt=e(ht)({host:pt,port:yt,database:ut,user:ct,password:ft,allowExitOnIdle:!0,idleTimeoutMillis:100});describe("db",(()=>{describe("getConnection",(()=>{it("Should establish a database connection",(async()=>{t(gt).to.not.be.undefined}))})),describe("getConnection",(()=>{it("Should establish a database connection",(async()=>{const e=await gt.any('SELECT "rev" FROM "NonStandard" LIMIT 1');t(e).to.not.be.undefined}))}))}));
