"use strict";var e=require("chai");var t=require("pg-promise");var r=require("pg-monitor");require("exponential-backoff");var n=require("dotenv");var o=require("is-primitive");var i=require("is-plain-object");var s=require("fs");var a=require("os");var l=require("path");var u=require("url");var c=require("winston");function f(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("bitcoin-computer-bitcore");var p=f(t);var d=f(r);var y=f(n);var h=f(o);var v=f(i);var m=f(s);var g=f(a);const{deleteProperty:b}=Reflect;const S=h.default;const _=v.default;const w=e=>"object"==typeof e&&null!==e||"function"==typeof e;const E=e=>{if(!S(e))throw new TypeError("Object keys must be strings or symbols");if((e=>"__proto__"===e||"constructor"===e||"prototype"===e)(e))throw new Error(`Cannot set unsafe key: "${e}"`)};const R=(e,t)=>t&&"function"==typeof t.split?t.split(e):"symbol"==typeof e?[e]:Array.isArray(e)?e:((e,t,r)=>{const n=(e=>Array.isArray(e)?e.flat().map(String).join(","):e)(t?((e,t)=>{if("string"!=typeof e||!t)return e;let r=e+";";return void 0!==t.arrays&&(r+=`arrays=${t.arrays};`),void 0!==t.separator&&(r+=`separator=${t.separator};`),void 0!==t.split&&(r+=`split=${t.split};`),void 0!==t.merge&&(r+=`merge=${t.merge};`),void 0!==t.preservePaths&&(r+=`preservePaths=${t.preservePaths};`),r})(e,t):e);E(n);const o=T.cache.get(n)||r();return T.cache.set(n,o),o})(e,t,(()=>((e,t={})=>{const r=t.separator||".";const n="/"!==r&&t.preservePaths;if("string"==typeof e&&!1!==n&&/\//.test(e))return[e];const o=[];let i="";const s=e=>{let t;""!==e.trim()&&Number.isInteger(t=Number(e))?o.push(t):o.push(e)};for(let t=0;t<e.length;t++){const n=e[t];"\\"!==n?n!==r?i+=n:(s(i),i=""):i+=e[++t]}return i&&s(i),o})(e,t)));const O=(e,t,r,n)=>{if(E(t),void 0===r)b(e,t);else if(n&&n.merge){const o="function"===n.merge?n.merge:Object.assign;o&&_(e[t])&&_(r)?e[t]=o(e[t],r):e[t]=r}else e[t]=r;return e};const T=(e,t,r,n)=>{if(!t||!w(e))return e;const o=R(t,n);let i=e;for(let e=0;e<o.length;e++){const t=o[e];const s=o[e+1];if(E(t),void 0===s){O(i,t,r,n);break}"number"!=typeof s||Array.isArray(i[t])?(w(i[t])||(i[t]={}),i=i[t]):i=i[t]=[]}return e};T.split=R,T.cache=new Map,T.clear=()=>{T.cache=new Map};var P=T;var A=m.default;var N="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};var C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};var j=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();var k=function e(t,r){var n=r.indexOf(".");if(!~n){if(null==t)return;return t[r]}var o=r.substring(0,n),i=r.substring(n+1);if(null!=t)return t=t[o],i?e(t,i):t},I=P,F=function(e,t){if("function"!=typeof t)return JSON.parse(A.readFileSync(e));A.readFile(e,"utf-8",(function(e,r){try{r=JSON.parse(r)}catch(t){e=e||t}t(e,r)}))},L=m.default,M=g.default;var $=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=r=r||{},r.stringify_width=r.stringify_width||2,r.stringify_fn=r.stringify_fn||null,r.stringify_eol=r.stringify_eol||!1,r.ignore_dots=r.ignore_dots||!1,this.path=t,this.data=this.read()}return j(e,[{key:"set",value:function(e,t,r){var n=this;return"object"===(void 0===e?"undefined":C(e))?function(e,t){var r=0,n=[];if(Array.isArray(e))for(;r<e.length&&!1!==t(e[r],r);++r);else if("object"===(void 0===e?"undefined":N(e))&&null!==e)for(n=Object.keys(e);r<n.length&&!1!==t(e[n[r]],n[r]);++r);}(e,(function(e,t){I(n.data,t,e,r)})):this.options.ignore_dots?this.data[e]=t:I(this.data,e,t,r),this.options.autosave&&this.save(),this}},{key:"get",value:function(e){return e?this.options.ignore_dots?this.data[e]:k(this.data,e):this.toObject()}},{key:"unset",value:function(e){return this.set(e,void 0)}},{key:"append",value:function(e,t){var r=this.get(e);if(r=void 0===r?[]:r,!Array.isArray(r))throw new Error("The data is not an array!");return r.push(t),this.set(e,r),this}},{key:"pop",value:function(e){var t=this.get(e);if(!Array.isArray(t))throw new Error("The data is not an array!");return t.pop(),this.set(e,t),this}},{key:"read",value:function(e){if(!e)try{return F(this.path)}catch(e){return{}}F(this.path,(function(t,r){e(null,r=t?{}:r)}))}},{key:"write",value:function(e,t){return t?L.writeFile(this.path,e,t):L.writeFileSync(this.path,e),this}},{key:"empty",value:function(e){return this.write("{}",e)}},{key:"save",value:function(e){var t=JSON.stringify(this.data,this.options.stringify_fn,this.options.stringify_width,this.options.stringify_eol);return this.write(this.options.stringify_eol?t+M.EOL:t,e),this}},{key:"toObject",value:function(){return this.data}}]),e}();y.default.config();const q=function(e,t){return new $(e,{stringify_eol:!0})}(`${l.dirname(u.fileURLToPath("undefined"==typeof document?new(require("url").URL)("file:"+__filename).href:document.currentScript&&document.currentScript.src||new URL("db.cjs.test.js",document.baseURI).href))}/../../package.json`);const{PORT:H,ZMQ_URL:U,CHAIN:x,NETWORK:D,BCN_ENV:G,BCN_URL:W,DEBUG_MODE:Y,POSTGRES_USER:B,POSTGRES_PASSWORD:V,POSTGRES_DB:J,POSTGRES_HOST:z,POSTGRES_PORT:K,RPC_PROTOCOL:Q,RPC_USER:X,RPC_PASSWORD:Z,RPC_HOST:ee,RPC_PORT:te,SERVER_VERSION:re,TESTING:ne,DEFAULT_WALLET:oe,SYNC_HEIGHT:ie,SYNC_INTERVAL_CHECK:se,POSTGRES_MAX_PARAM_NUM:ae,DB_CONNECTION_RETRY_TIME:le,SIGNATURE_FRESHNESS_MINUTES:ue,ALLOWED_RPC_METHODS:ce,MWEB_HEIGHT:fe}=process.env;const pe=G||"dev";const de=parseInt(Y,10)||1;const ye=B||"bcn";const he=V||"bcn";const ve=J||"bcn";const me=z||"127.0.0.1";const ge=parseInt(K,10)||"5432";re||q.get("version"),!ce||ce.split(",").map((e=>new RegExp(e)));const be=c.createLogger({level:["error","warn","info","http","verbose","debug","silly"][de],format:c.format.json(),transports:[new c.transports.Console({format:c.format.combine(c.format.colorize(),c.format.timestamp({format:"MM-DD-YYYY HH:mm:ss"}),c.format.printf((e=>`[2m${e.timestamp}[0m ${e.level} ${e.message}`)))})],exceptionHandlers:[new c.transports.File({filename:"logs/exceptions.log"})],rejectionHandlers:[new c.transports.File({filename:"logs/rejections.log"})]});const Se={maxFiles:1,maxSize:1e5};de>=0&&be.add(new c.transports.File({filename:"error.log",level:"error"})),de>=1&&be.add(new c.transports.File({filename:"logs/warn.log",level:"warn",...Se})),de>=2&&be.add(new c.transports.File({filename:"logs/info.log",level:"info",...Se})),de>=3&&be.add(new c.transports.File({filename:"logs/http.log",level:"http",...Se})),de>=4&&be.add(new c.transports.File({filename:"logs/verbose.log",level:"verbose",...Se})),de>=5&&be.add(new c.transports.File({filename:"logs/debug.log",level:"debug",...Se}));const _e={error:(e,t)=>{if(t.cn){const{host:r,port:n,database:o,user:i,password:s}=t.cn;be.debug(`Waiting for db to start { message:${e.message} host:${r}, port:${n}, database:${o}, user:${i}, password: ${s}`)}},noWarnings:!0};"dev"===pe&&de>0&&(d.default.isAttached()?d.default.detach():(d.default.attach(_e),d.default.setTheme("matrix")));const we=p.default(_e)({host:me,port:ge,database:ve,user:ye,password:he,allowExitOnIdle:!0,idleTimeoutMillis:100});describe("db",(()=>{describe("getConnection",(()=>{it("Should establish a database connection",(async()=>{e.expect(we).to.not.be.undefined}))})),describe("getConnection",(()=>{it("Should establish a database connection",(async()=>{const t=await we.any('SELECT "rev" FROM "NonStandard" LIMIT 1');e.expect(t).to.not.be.undefined}))}))}));
