"use strict";var t=require("chai");var e=require("pg-promise");var r=require("pg-monitor");require("exponential-backoff");var n=require("dotenv");var o=require("is-primitive");var i=require("is-plain-object");var s=require("fs");var a=require("os");var l=require("winston");function c(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}require("bitcoin-computer-bitcore");var f=c(e);var u=c(r);var p=c(n);var d=c(o);var y=c(i);var S=c(s);var h=c(a);const{deleteProperty:v}=Reflect;const _=d.default;const g=y.default;const m=t=>"object"==typeof t&&null!==t||"function"==typeof t;const E=t=>{if(!_(t))throw new TypeError("Object keys must be strings or symbols");if((t=>"__proto__"===t||"constructor"===t||"prototype"===t)(t))throw new Error(`Cannot set unsafe key: "${t}"`)};const O=(t,e)=>e&&"function"==typeof e.split?e.split(t):"symbol"==typeof t?[t]:Array.isArray(t)?t:((t,e,r)=>{const n=(t=>Array.isArray(t)?t.flat().map(String).join(","):t)(e?((t,e)=>{if("string"!=typeof t||!e)return t;let r=t+";";return void 0!==e.arrays&&(r+=`arrays=${e.arrays};`),void 0!==e.separator&&(r+=`separator=${e.separator};`),void 0!==e.split&&(r+=`split=${e.split};`),void 0!==e.merge&&(r+=`merge=${e.merge};`),void 0!==e.preservePaths&&(r+=`preservePaths=${e.preservePaths};`),r})(t,e):t);E(n);const o=R.cache.get(n)||r();return R.cache.set(n,o),o})(t,e,(()=>((t,e={})=>{const r=e.separator||".";const n="/"!==r&&e.preservePaths;if("string"==typeof t&&!1!==n&&/\//.test(t))return[t];const o=[];let i="";const s=t=>{let e;""!==t.trim()&&Number.isInteger(e=Number(t))?o.push(e):o.push(t)};for(let e=0;e<t.length;e++){const n=t[e];"\\"!==n?n!==r?i+=n:(s(i),i=""):i+=t[++e]}return i&&s(i),o})(t,e)));const b=(t,e,r,n)=>{if(E(e),void 0===r)v(t,e);else if(n&&n.merge){const o="function"===n.merge?n.merge:Object.assign;o&&g(t[e])&&g(r)?t[e]=o(t[e],r):t[e]=r}else t[e]=r;return t};const R=(t,e,r,n)=>{if(!e||!m(t))return t;const o=O(e,n);let i=t;for(let t=0;t<o.length;t++){const e=o[t];const s=o[t+1];if(E(e),void 0===s){b(i,e,r,n);break}"number"!=typeof s||Array.isArray(i[e])?(m(i[e])||(i[e]={}),i=i[e]):i=i[e]=[]}return t};R.split=O,R.cache=new Map,R.clear=()=>{R.cache=new Map};var T=R;var P=S.default;var w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};var C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};var N=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}();var A=function t(e,r){var n=r.indexOf(".");if(!~n){if(null==e)return;return e[r]}var o=r.substring(0,n),i=r.substring(n+1);if(null!=e)return e=e[o],i?t(e,i):e},D=T,G=function(t,e){if("function"!=typeof e)return JSON.parse(P.readFileSync(t));P.readFile(t,"utf-8",(function(t,r){try{r=JSON.parse(r)}catch(e){t=t||e}e(t,r)}))},L=S.default,M=h.default;var I=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.options=r=r||{},r.stringify_width=r.stringify_width||2,r.stringify_fn=r.stringify_fn||null,r.stringify_eol=r.stringify_eol||!1,r.ignore_dots=r.ignore_dots||!1,this.path=e,this.data=this.read()}return N(t,[{key:"set",value:function(t,e,r){var n=this;return"object"===(void 0===t?"undefined":C(t))?function(t,e){var r=0,n=[];if(Array.isArray(t))for(;r<t.length&&!1!==e(t[r],r);++r);else if("object"===(void 0===t?"undefined":w(t))&&null!==t)for(n=Object.keys(t);r<n.length&&!1!==e(t[n[r]],n[r]);++r);}(t,(function(t,e){D(n.data,e,t,r)})):this.options.ignore_dots?this.data[t]=e:D(this.data,t,e,r),this.options.autosave&&this.save(),this}},{key:"get",value:function(t){return t?this.options.ignore_dots?this.data[t]:A(this.data,t):this.toObject()}},{key:"unset",value:function(t){return this.set(t,void 0)}},{key:"append",value:function(t,e){var r=this.get(t);if(r=void 0===r?[]:r,!Array.isArray(r))throw new Error("The data is not an array!");return r.push(e),this.set(t,r),this}},{key:"pop",value:function(t){var e=this.get(t);if(!Array.isArray(e))throw new Error("The data is not an array!");return e.pop(),this.set(t,e),this}},{key:"read",value:function(t){if(!t)try{return G(this.path)}catch(t){return{}}G(this.path,(function(e,r){t(null,r=e?{}:r)}))}},{key:"write",value:function(t,e){return e?L.writeFile(this.path,t,e):L.writeFileSync(this.path,t),this}},{key:"empty",value:function(t){return this.write("{}",t)}},{key:"save",value:function(t){var e=JSON.stringify(this.data,this.options.stringify_fn,this.options.stringify_width,this.options.stringify_eol);return this.write(this.options.stringify_eol?e+M.EOL:e,t),this}},{key:"toObject",value:function(){return this.data}}]),t}();p.default.config();const k=new I(`${__dirname}/../../package.json`,{stringify_eol:!0});const{PORT:H="3000",ZMQ_URL:U="tcp://litecoind:28332",CHAIN:F="LTC",NETWORK:j="regtest",BCN_ENV:$="dev",BCN_URL:B="http://127.0.0.1:3000",DEBUG_MODE:W="1",POSTGRES_USER:q="bcn",POSTGRES_PASSWORD:x="bcn",POSTGRES_DB:Y="bcn",POSTGRES_HOST:V="127.0.0.1",POSTGRES_PORT:J="5432",RPC_PROTOCOL:K="http",RPC_USER:z="bcn-admin",RPC_PASSWORD:Z="kH4nU5Okm6-uyC0_mA5ztVNacJqZbYd_KGLl6mx722A=",RPC_HOST:Q="litecoind",RPC_PORT:X="19332",TESTING:tt=!1,DEFAULT_WALLET:et="defaultwallet"}=process.env;const rt=process.env.ALLOWED_RPC_METHODS?process.env.ALLOWED_RPC_METHODS.split(",").map((t=>new RegExp(t))):[];const nt=k.get("version");var ot={PORT:parseInt(H,10),ZMQ_URL:U,CHAIN:F,NETWORK:j,BCN_ENV:$,BCN_URL:B,DEBUG_MODE:parseInt(W,10),POSTGRES_USER:q,POSTGRES_PASSWORD:x,POSTGRES_DB:Y,POSTGRES_HOST:V,POSTGRES_PORT:parseInt(J,10),POSTGRES_MAX_PARAM_NUM:1e4,RPC_PROTOCOL:K,RPC_USER:z,RPC_PASSWORD:Z,RPC_HOST:Q,RPC_PORT:parseInt(X,10),SYNC_HEIGHT:1,SYNC_INTERVAL_CHECK:3e3,SERVER_VERSION:nt,TESTING:JSON.parse(tt.toString()),DB_CONNECTION_RETRY_TIME:500,SIGNATURE_FRESHNESS_MINUTES:3,DEFAULT_WALLET:et,ALLOWED_RPC_METHODS:rt};const{DEBUG_MODE:st}=ot;const at=l.createLogger({level:["error","warn","info","http","verbose","debug","silly"][st],format:l.format.json(),transports:[new l.transports.Console({format:l.format.combine(l.format.colorize(),l.format.timestamp({format:"MM-DD-YYYY HH:mm:ss"}),l.format.printf((t=>`[2m${t.timestamp}[0m ${t.level} ${t.message}`)))})],exceptionHandlers:[new l.transports.File({filename:"logs/exceptions.log"})],rejectionHandlers:[new l.transports.File({filename:"logs/rejections.log"})]});const lt={maxFiles:1,maxSize:1e5};st>=0&&at.add(new l.transports.File({filename:"error.log",level:"error"})),st>=1&&at.add(new l.transports.File({filename:"logs/warn.log",level:"warn",...lt})),st>=2&&at.add(new l.transports.File({filename:"logs/info.log",level:"info",...lt})),st>=3&&at.add(new l.transports.File({filename:"logs/http.log",level:"http",...lt})),st>=4&&at.add(new l.transports.File({filename:"logs/verbose.log",level:"verbose",...lt})),st>=5&&at.add(new l.transports.File({filename:"logs/debug.log",level:"debug",...lt}));const{POSTGRES_HOST:ct,POSTGRES_PORT:ft,POSTGRES_DB:ut,POSTGRES_USER:pt,POSTGRES_PASSWORD:dt,DB_CONNECTION_RETRY_TIME:yt}=ot;const St={error:(t,e)=>{if(e.cn){const{host:r,port:n,database:o,user:i,password:s}=e.cn;at.debug(`Waiting for db to start { message:${t.message} host:${r}, port:${n}, database:${o}, user:${i}, password: ${s}`)}},noWarnings:!0};"dev"===ot.BCN_ENV&&ot.DEBUG_MODE>0&&(u.default.isAttached()?u.default.detach():(u.default.attach(St),u.default.setTheme("matrix")));const ht=f.default(St)({host:ct,port:ft,database:ut,user:pt,password:dt,allowExitOnIdle:!0,idleTimeoutMillis:100});describe("db",(()=>{describe("getConnection",(()=>{it("Should establish a database connection",(async()=>{t.expect(ht).to.not.be.undefined}))})),describe("getConnection",(()=>{it("Should establish a database connection",(async()=>{const e=await ht.any('SELECT "rev" FROM "NonStandard" LIMIT 1');t.expect(e).to.not.be.undefined}))}))}));
