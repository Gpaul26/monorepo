import t from"chai";import e from"sinon";import r from"sinon-chai";import n from"pg-promise";import o from"pg-monitor";import"exponential-backoff";import s from"dotenv";import i from"is-primitive";import a from"is-plain-object";import c from"fs";import l from"os";import{dirname as f}from"path";import{fileURLToPath as p}from"url";import{createLogger as u,format as d,transports as m}from"winston";import"bitcoin-computer-bitcore";const{deleteProperty:h}=Reflect;const y=i;const g=a;const v=t=>"object"==typeof t&&null!==t||"function"==typeof t;const S=t=>{if(!y(t))throw new TypeError("Object keys must be strings or symbols");if((t=>"__proto__"===t||"constructor"===t||"prototype"===t)(t))throw new Error(`Cannot set unsafe key: "${t}"`)};const b=(t,e)=>e&&"function"==typeof e.split?e.split(t):"symbol"==typeof t?[t]:Array.isArray(t)?t:((t,e,r)=>{const n=(t=>Array.isArray(t)?t.flat().map(String).join(","):t)(e?((t,e)=>{if("string"!=typeof t||!e)return t;let r=t+";";return void 0!==e.arrays&&(r+=`arrays=${e.arrays};`),void 0!==e.separator&&(r+=`separator=${e.separator};`),void 0!==e.split&&(r+=`split=${e.split};`),void 0!==e.merge&&(r+=`merge=${e.merge};`),void 0!==e.preservePaths&&(r+=`preservePaths=${e.preservePaths};`),r})(t,e):t);S(n);const o=w.cache.get(n)||r();return w.cache.set(n,o),o})(t,e,(()=>((t,e={})=>{const r=e.separator||".";const n="/"!==r&&e.preservePaths;if("string"==typeof t&&!1!==n&&/\//.test(t))return[t];const o=[];let s="";const i=t=>{let e;""!==t.trim()&&Number.isInteger(e=Number(t))?o.push(e):o.push(t)};for(let e=0;e<t.length;e++){const n=t[e];"\\"!==n?n!==r?s+=n:(i(s),s=""):s+=t[++e]}return s&&i(s),o})(t,e)));const E=(t,e,r,n)=>{if(S(e),void 0===r)h(t,e);else if(n&&n.merge){const o="function"===n.merge?n.merge:Object.assign;o&&g(t[e])&&g(r)?t[e]=o(t[e],r):t[e]=r}else t[e]=r;return t};const w=(t,e,r,n)=>{if(!e||!v(t))return t;const o=b(e,n);let s=t;for(let t=0;t<o.length;t++){const e=o[t];const i=o[t+1];if(S(e),void 0===i){E(s,e,r,n);break}"number"!=typeof i||Array.isArray(s[e])?(v(s[e])||(s[e]={}),s=s[e]):s=s[e]=[]}return t};w.split=b,w.cache=new Map,w.clear=()=>{w.cache=new Map};var _=w;var R=c;var O="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};var T="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};var $=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}();var N=function t(e,r){var n=r.indexOf(".");if(!~n){if(null==e)return;return e[r]}var o=r.substring(0,n),s=r.substring(n+1);if(null!=e)return e=e[o],s?t(e,s):e},P=_,A=function(t,e){if("function"!=typeof e)return JSON.parse(R.readFileSync(t));R.readFile(t,"utf-8",(function(t,r){try{r=JSON.parse(r)}catch(e){t=t||e}e(t,r)}))},C=c,I=l;var M=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.options=r=r||{},r.stringify_width=r.stringify_width||2,r.stringify_fn=r.stringify_fn||null,r.stringify_eol=r.stringify_eol||!1,r.ignore_dots=r.ignore_dots||!1,this.path=e,this.data=this.read()}return $(t,[{key:"set",value:function(t,e,r){var n=this;return"object"===(void 0===t?"undefined":T(t))?function(t,e){var r=0,n=[];if(Array.isArray(t))for(;r<t.length&&!1!==e(t[r],r);++r);else if("object"===(void 0===t?"undefined":O(t))&&null!==t)for(n=Object.keys(t);r<n.length&&!1!==e(t[n[r]],n[r]);++r);}(t,(function(t,e){P(n.data,e,t,r)})):this.options.ignore_dots?this.data[t]=e:P(this.data,t,e,r),this.options.autosave&&this.save(),this}},{key:"get",value:function(t){return t?this.options.ignore_dots?this.data[t]:N(this.data,t):this.toObject()}},{key:"unset",value:function(t){return this.set(t,void 0)}},{key:"append",value:function(t,e){var r=this.get(t);if(r=void 0===r?[]:r,!Array.isArray(r))throw new Error("The data is not an array!");return r.push(e),this.set(t,r),this}},{key:"pop",value:function(t){var e=this.get(t);if(!Array.isArray(e))throw new Error("The data is not an array!");return e.pop(),this.set(t,e),this}},{key:"read",value:function(t){if(!t)try{return A(this.path)}catch(t){return{}}A(this.path,(function(e,r){t(null,r=e?{}:r)}))}},{key:"write",value:function(t,e){return e?C.writeFile(this.path,t,e):C.writeFileSync(this.path,t),this}},{key:"empty",value:function(t){return this.write("{}",t)}},{key:"save",value:function(t){var e=JSON.stringify(this.data,this.options.stringify_fn,this.options.stringify_width,this.options.stringify_eol);return this.write(this.options.stringify_eol?e+I.EOL:e,t),this}},{key:"toObject",value:function(){return this.data}}]),t}();s.config();const F=new M(`${f(p(import.meta.url))}/../../package.json`,{stringify_eol:!0});const{PORT:x,ZMQ_URL:H,CHAIN:j,NETWORK:k,BCN_ENV:L,BCN_URL:U,DEBUG_MODE:D,POSTGRES_USER:G,POSTGRES_PASSWORD:B,POSTGRES_DB:W,POSTGRES_HOST:Y,POSTGRES_PORT:K,RPC_PROTOCOL:V,RPC_USER:J,RPC_PASSWORD:z,RPC_HOST:X,RPC_PORT:q,SERVER_VERSION:Q,TESTING:Z,DEFAULT_WALLET:tt,SYNC_HEIGHT:et,SYNC_INTERVAL_CHECK:rt,POSTGRES_MAX_PARAM_NUM:nt,DB_CONNECTION_RETRY_TIME:ot,SIGNATURE_FRESHNESS_MINUTES:st,ALLOWED_RPC_METHODS:at,MWEB_HEIGHT:ct}=process.env;const lt=L||"dev";const ft=parseInt(D,10)||1;const pt=G||"bcn";const ut=B||"bcn";const dt=W||"bcn";const mt=Y||"127.0.0.1";const ht=parseInt(K,10)||"5432";Q||F.get("version");const yt=parseInt(nt,10)||1e4;!at||at.split(",").map((t=>new RegExp(t)));const gt=u({level:["error","warn","info","http","verbose","debug","silly"][ft],format:d.json(),transports:[new m.Console({format:d.combine(d.colorize(),d.timestamp({format:"MM-DD-YYYY HH:mm:ss"}),d.printf((t=>`[2m${t.timestamp}[0m ${t.level} ${t.message}`)))})],exceptionHandlers:[new m.File({filename:"logs/exceptions.log"})],rejectionHandlers:[new m.File({filename:"logs/rejections.log"})]});const vt={maxFiles:1,maxSize:1e5};ft>=0&&gt.add(new m.File({filename:"error.log",level:"error"})),ft>=1&&gt.add(new m.File({filename:"logs/warn.log",level:"warn",...vt})),ft>=2&&gt.add(new m.File({filename:"logs/info.log",level:"info",...vt})),ft>=3&&gt.add(new m.File({filename:"logs/http.log",level:"http",...vt})),ft>=4&&gt.add(new m.File({filename:"logs/verbose.log",level:"verbose",...vt})),ft>=5&&gt.add(new m.File({filename:"logs/debug.log",level:"debug",...vt}));const St={error:(t,e)=>{if(e.cn){const{host:r,port:n,database:o,user:s,password:i}=e.cn;gt.debug(`Waiting for db to start { message:${t.message} host:${r}, port:${n}, database:${o}, user:${s}, password: ${i}`)}},noWarnings:!0};"dev"===lt&&ft>0&&(o.isAttached()?o.detach():(o.attach(St),o.setTheme("matrix")));const bt=n(St)({host:mt,port:ht,database:dt,user:pt,password:ut,allowExitOnIdle:!0,idleTimeoutMillis:100});const{PreparedStatement:Et}=n;class wt{static async select(t){const e=new Et({name:`Standard.select.${Math.random()}`,text:'SELECT "address", "satoshis", "scriptPubKey", "rev" FROM "Standard" WHERE "address" = $1 AND "spent" = FALSE',values:[t]});return(await bt.any(e)).map((t=>({...t,satoshis:parseInt(t.satoshis,10)})))}static async insert(t){const e=t.flatMap((t=>[t.rev,t.address,t.satoshis,t.scriptPubKey,!1]));for(;e.length;){const t=e.splice(0,yt);const r=[];for(let e=1;e<=t.length;e+=5)r.push(`($${e}, $${e+1}, $${e+2}, $${e+3}, $${e+4})`);const n=r.join(",");const o=new Et({name:`Standard.insert.${Math.random()}`,text:`INSERT INTO "Standard"("rev", "address", "satoshis", "scriptPubKey", "spent") VALUES ${n}  ON CONFLICT DO NOTHING`,values:t});await bt.none(o)}}static async update(t){const e=t.flatMap((t=>[`${t.prevTxId.toString("hex")}/${t.outputIndex}`]));if(0===e.length)return[];const r=[];for(let t=1;t<=e.length;t+=1)r.push(`("rev" = $${t})`);const n=r.join(" OR ");const o=new Et({name:`Standard.update.${Math.random()}`,text:`UPDATE "Standard" SET "spent" = TRUE WHERE ${n} RETURNING "rev"`,values:e});return bt.any(o)}static async getBalance(t){const e=new Et({name:`Standard.getBalance.${Math.random()}`,text:'SELECT SUM("satoshis") FROM "Standard" WHERE "address" = $1 AND "spent" = FALSE',values:[t]});const r=await bt.oneOrNone(e);return parseInt(r?.sum,10)||0}}t.use(r);const{expect:_t}=t;describe("services",(()=>{describe("standardUtxo.service",(()=>{it("Should return the balance of an address",(async()=>{const t="1C9UbB9P8Jba21mLiEXio14eRg8cBn9wyx";const r=e.stub(wt,"getBalance").resolves(100);const n=await wt.getBalance(t);_t(r.calledWith(t)).to.be.true,_t(n).eq(100),r.restore()}))}))}));
